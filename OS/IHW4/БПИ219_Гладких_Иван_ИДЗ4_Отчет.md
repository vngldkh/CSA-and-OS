# Гладких Иван Дмитриевич БПИ219
## Вариант 21

\
*Задача о программистах.*

В отделе работают три программиста. Каждый программист пишет свою программу и отдает ее на проверку другому случайному программисту. Программист переключается на проверку чужой программы, когда его собственная уже написана и передана на проверку. По завершении проверки, программист возвращает программу с результатом (формируемым случайно по любому из выбранных Вами законов): программа написана правильно или неправильно. Программист спит, если отправил свою программу и не проверяет чужую программу. Программист просыпается, когда получает заключение от другого программиста. Если программа признана правильной, программист пишет другую программу, если программа признана неправильной, программист исправляет ее и отправляет на проверку тому же программисту, который ее проверял. К исправлению своей программы он приступает, завершив проверку чужой программы. Проверки и коррекции одной программы могут проходить многократно (правильность программы задается случайным образом). При наличии в очереди проверяемых программ и приходе заключения о неправильной своей программы программист может выбирать любую из возможных работ. Создать приложение, моделирующее работу программистов. Каждый программист — отдельный клиент. Сервер обеспечивает передачу данных между клиентами.

**Работа выполнена на 8 баллов.**

### Схема решения

\
*Основная часть*

Так как не было указано, что подразумевается под программой, было принято решение передавать её в виде 3 чисел - код отправителя, номер программы и резльтута проверки (0 - не проверена, 1 - верно, -1 - неверно). Для каждого программиста свой массив в разделяемой памяти и свой семафор.

В файле common.h объявлены глобальные константы PROGS и PROGRAMMERS, задающие число программ, которые необходимо написать каждому программисту, и число программистов. По умолчанию они имеют значения 10 и 3, соответственно. При желании их можно изменить (необходимо заново скомпилировать).   
Также в решении на 6-7 появляется константа MAX_MSG, задающая максимальный размер сообщения, передаваемого клинту-монитору.   
В решении на 8 баллов появляется константа MAX_MONITORS, которая задаёт максимальное число клиентов-мониторов. При желании её так же можно изменить.


#### Программист
Каждый программист - клиент. 
Пока он не завершит написание PROGS программ, он циклически повторяет следующие действия:
1. Пишет программу (или дописывает предыдущую) и отправляет её на сервер в формате [№ программы, id отправителя, 0]. 
2. Получает отправленную текущему пользователю программу с сервера. Повторяется пока не будет получена назад отправленная программа.
    -  Если результат проверки полученной программы - 0, то это программа чужого программиста, отправленная на проверку. Программист проверяет программу (с 80% шансом одобряет, с 20% отправляет на доработку), записывает результат проверки (-1 - программа некоректна, 1 - программа верна) и отправляет на сервер.
    -  Если результат проверки ненулевой, значит, это программа данного программиста была возвращена после проверки. Если результат - 1, программист приступает к написанию следующей программы, иначе - дорабатывает текущую.

Когда все программы уже написаны, программисту остается только проверять поступающие программы., пока он не получит [-1, -1, -1] в ответ.


#### Сервер
Сервер представляет собой единственный поток.  
Сначала он PROGRAMMERS получает сообщение "0" от всех клиентов программистов и сохраняет их адреса в массиве clntAddr. 
Затем в решении на 6-7 сервер получает сообщение "0" от клиента-монитора, а в решении на 8 от monitors_count клиентов-мониторов (задаётся вторым дополнительным аргументом командной строки) и сохраняет полученный(-ые) адрес(-а) в monitorsAddr.
Затем сервер отправляет всем клиентам программистов их идентификатор.
Пока сервер не получит PROGS * PROGRAMMERS программ с положительным результатом проверки (то есть пока все программисты не напишут по PROGS программ), он получает информацию о программах из любых источников и в соответствии с содержимым отправляет нужному клиенту: если результат проверки (третий элемент массива) - 0, то программа была только (до-)написана и отправлена на проверку - сервер выбирает проверяющего и отправляет ему информацию о программе; если результат проверки ненулевой, то программа была возвращена после проверки - сервер отправляет её автору (второй элемент массива).
Когда сервер получает PROGS * PROGRAMMERS одобренных после проверки программ, всем клиентам рассылается сообщение [-1, -1, -1], обозначающее конец работы.


#### Монитор

Сообщения на клиенты-мониторы отправляется с помощью функции SendToMonitors, описанной в HandleClient.c.
Если это решение на 6-7, то обязательно подключается один монитор (после клиентов программистов).
Если это решение на 8, то количество мониторов задаётся аргументом командной строки (из диапазона [0, MAX_MONITORS]) и сохраняется в monitors_count. При вызове SendToMonitors сообщение отправляется всем связанным мониторам.

### Правила запуска

*Решение на 4-5*

1. Необходимо запустить Server (сервер). Принимает порт в качестве аргумента командной строки.
2. Необходимо запустить PROGRAMMERS раз Programmer (клиент программиста) с аргументами 
    - IP сервера;
    - Указанный ранее порт.

*Решение на 6-7*
1. Необходимо запустить Server (сервер). Принимает порт в качестве аргумента командной строки.
2. Необходимо запустить PROGRAMMERS раз Programmer (клиент программиста) с аргументами 
    - IP сервера;
    - Указанный ранее порт.
3. Обязательно запустить Monitor (клиент-монитор) аналогично клиенту программиста.

*Решение на 8*
1. Необходимо запустить Server (сервер). В качестве аргументов командной строки принимает порт и количество клиентов-мониторов [0, MAX_MONITORS].
2. Необходимо запустить PROGRAMMERS раз Programmer (клиент программиста) с аргументами 
    - IP сервера;
    - Указанный ранее порт.
3. Обязательно запустить указанное число клиентов Monitor аналогично клиенту программиста.

### Содержание

*Папки*
- /mark4-5 - решение на 4-5
- /mark6-7 - решение на 6-7
- /mark8 - решение на 8

*Исходный код*
- common.h - header-файл для описания глобальных констант и переменных
- EchoServer.h - объявление функций сервера
- DieWithError.c - аварийное завершение работы
- EchoServer-Thread.c - описание сервера
- HandleClient.c - описания функции для взаимодействия сервера с клиентами программистов
- Programmer.c - описание клиента программиста
- Monitor.c - описание клиента-монитора

*Исполняемые файлы*
- Server - сервер
- Programmer - клиент программиста
- Monitor - клиент-монитор
